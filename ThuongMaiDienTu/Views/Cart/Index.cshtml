
@{
    int soLuongGioHang = Session["cart"] == null ? 0 : ((List<PRODUCT>)Session["cart"]).Count();
    Layout = "~/Views/Shared/_Layout.cshtml";
    int tongTien = 0;
}
<style>
    .btn-outline-primary a {
        color: #5bc0de !important;
    }
</style>
<link href="~/Content/Gio-hang.css" rel="stylesheet" />
<br />
@if (soLuongGioHang > 0)
{
    <form action="#" method="post" id="formPayment">
        <div class="container">
            <div class="row">
                <div class="col">
                    <h2 class="text-center">Thông tin giỏ hàng</h2>
                    <div class="container">
                        @if (!String.IsNullOrEmpty(ViewBag.Error))
                        {
                            <div class="alert alert-danger" role="alert">
                                @ViewBag.Error
                            </div>

                        }


                        <table id="cart" class="table table-hover table-condensed">
                            <thead>
                                <tr>
                                    <th style="width:50%">Tên sản phẩm</th>
                                    <th style="width:22%" class="text-center">Thành tiền</th>
                                    <th style="width:10%"> </th>
                                </tr>
                            </thead>
                            <tbody>
                                @using (THUONGMAIDIENTUEntities db = new THUONGMAIDIENTUEntities())
                                {
                                    foreach (var product in ((List<PRODUCT>)Session["cart"]))
                                    {
                                        var item = db.PRODUCTs.Where(x => x.IdProduct == product.IdProduct).FirstOrDefault();
                                        tongTien += (int)item.ProductPrice;
                                        <tr>
                                            <td data-th="Product">
                                                <div class="row">
                                                    <div class="col-sm-2 hidden-xs">
                                                        <img src="~/img/product/@item.PRODUCT_IMG.FirstOrDefault().Filename"
                                                             alt="@item.ProductName" class="img-responsive" width="100">
                                                    </div>
                                                    <div class="col-sm-10">
                                                        <h4 class="nomargin">@item.ProductName</h4>
                                                    </div>
                                                </div>
                                            </td>
                                            <td data-th="Price">@String.Format("{0:N0}", item.ProductPrice) VNĐ</td>

                                            <td class="actions" data-th="">

                                                <button class="btn btn-danger btn-sm" onclick="RemoveCart(@item.IdProduct)">
                                                    <i class="fa fa-trash-o"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }

                            </tbody>

                        </table>

                        <div class="thong-tin-kh">
                            <div class="row">
                                <div class="col-4">
                                    <div class="form-group">
                                        <p>Số điện thoại</p>
                                        <input type="text" name="CustomerPhone" class="form-control" placeholder="Số Điện Thoại..." onchange="GetCustomer()" required>
                                    </div>
                                </div>

                                <div class="col-4">
                                    <div class="form-group">
                                        <p>Họ và tên</p>
                                        <input type="text" name="CustomerName" class="form-control" placeholder="Nhập tên...." required>
                                    </div>
                                </div>

                                <div class="col-4">
                                    <div class="form-group">
                                        <p>Email</p>
                                        <input type="text" name="CustomerEmail" class="form-control" placeholder="Email...">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <p>Địa chỉ</p>
                                <input type="text" name="CustomerAddress" class="form-control" placeholder="Địa chỉ.." required>
                            </div>
                            <div class="form-group">
                                <p>Ghi chú</p>
                                <input type="text" name="CustomerComment" class="form-control" placeholder="Yêu cầu khác..">
                            </div>

                            <div class="form-group">
                                <p>Mã giảm giá</p>
                                <input type="text" name="Giftcode" class="form-control" placeholder="Nhập mã giảm giá của bạn vào đây nếu có">
                            </div>

                        </div>
                        <div class="text-right">
                            <h3>Tổng tiền: @String.Format("{0:N0}", tongTien) VNĐ</h3>
                        </div>
                        <br>
                        <input name="PaymentMethod" id="PaymentMethod" hidden />
                        <input name="BankCode" id="BankCode" hidden />
                        <div class="text-right" id="btnPayment">
                            <button class="btn btn-lg btn-primary" type="button" onclick="Payment(1)">Đặt hàng COD</button>
                            <button class="btn btn-lg btn-success" type="button" onclick="Payment(2)">Thanh Toán Online</button>
                        </div>

                        


             


                    </div>
                </div>
            </div>
        </div>
    </form>
}
else
{
    <div class="container">
        <div class="row">
            <div class="col">
                <div class="container">
                    <img src="~/img/product/empty-cart.png" class="img-cart-empty" width="100%">
                    <a class="btn btn-outline-primary btn-block" role="button" href="/">Quay về mua hàng</a>
                </div>
            </div>
        </div>
    </div>

}



<div id="create-category-model" class="modal fade create-category-md" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thanh toán</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body row">
                @{
                    string listBank = "VIETCOMBANK,VIETINBANK,BIDV,AGRIBANK,SACOMBANK,TECHCOMBANK,ACB,VPBANK,DONGABANK,EXIMBANK,TPBANK,NCB,OJB,MSBANK,HDBANK,NAMABANK,OCB,VISA,MASTERCARD,JCB,VNMART,SCB,IVB,ABBANK,SHB,VIB,VNPAYQR,VIETCAPITALBANK,PVCOMBANK,SAIGONBANK,MBBANK,BACABANK,UPI";
                    string[] dsBank = listBank.Split(',');
                    foreach (var bank in dsBank)
                    {
                        <div class="col-3">
                            <img style="cursor: pointer" width="100%" src="~/img/bank/@(bank).png" onclick="ChooseBank('@bank')" />
                        </div>
                    }
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script>
    function GetCustomer() {
        var phone = $("[name='CustomerPhone']").val();
        if (phone == '') return;
        $.ajax({
            url: '/Ajax/GetCustomer?phone=' + phone,
            type: 'GET',
            dataType: 'text'
        }).done(function (ketqua) {
            if (ketqua == null) return;
            var json = JSON.parse(ketqua);
            $("[name='CustomerName']").val(json.Name);
            $("[name='CustomerAddress']").val(json.Address);
            $("[name='CustomerEmail']").val(json.Email);
        });

    }

    function ChooseBank(id) {
        $("#BankCode").val(id);
        $("#formPayment").submit();
    }

    function Payment(id) {
        $("#PaymentMethod").val(id);
        if (id == 2) {
            $('#create-category-model').modal('show');
            return;
        }
        $("#formPayment").submit();
    }

    function RemoveCart(id) {
        $.ajax({
            url: '/Ajax/RemoveCart/' + id,
            type: 'GET',
            dataType: 'text'
        }).done(function (ketqua) {
            var json = JSON.parse(ketqua);
            if (json.Success == "1") {
                location.reload();
                return;
            }
            alert(json.Message);
        });
    }
</script>